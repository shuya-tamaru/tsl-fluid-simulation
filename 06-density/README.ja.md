# 06-density - SPH å¯†åº¦è¨ˆç®—

> [English version is here](README.md)

TSL ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ SPHï¼ˆSmoothed Particle Hydrodynamicsï¼‰å¯†åº¦è¨ˆç®—ã‚’å®Ÿè£…ã—ã€åœ§åŠ›è¨ˆç®—ã®æº–å‚™ã‚’è¡Œã†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
src/
â”œâ”€â”€ main.ts
â””â”€â”€ app/
    â”œâ”€â”€ App.ts                    # å¯†åº¦è¨ˆç®—å¯¾å¿œãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
    â”œâ”€â”€ core/                     # ã‚³ã‚¢ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆå‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ï¼‰
    â”œâ”€â”€ simulation/
    â”‚   â”œâ”€â”€ boundary/
    â”‚   â”‚   â””â”€â”€ BoundaryBox.ts    # å¢ƒç•Œã‚³ãƒ³ãƒ†ãƒŠ
    â”‚   â””â”€â”€ sph/
    â”‚       â”œâ”€â”€ Particle.ts       # å¯†åº¦ãƒãƒƒãƒ•ã‚¡ä»˜ããƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚·ã‚¹ãƒ†ãƒ 
    â”‚       â”œâ”€â”€ SPHConfig.ts      # ã‚«ãƒ¼ãƒãƒ«é–¢æ•°ã‚’å«ã‚€SPHãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    â”‚       â””â”€â”€ calculate/
    â”‚           â”œâ”€â”€ density.ts    # TSLå¯†åº¦è¨ˆç®—ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆã‚·ã‚§ãƒ¼ãƒ€ãƒ¼
    â”‚           â””â”€â”€ integrate.ts  # ç‰©ç†ç©åˆ†ï¼ˆå‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ï¼‰
    â””â”€â”€ types/
        â”œâ”€â”€ UniformType.ts        # TSLãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ å‹
        â””â”€â”€ BufferType.ts         # ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒƒãƒ•ã‚¡å‹
```

## ä¸»ãªç‰¹å¾´

### ğŸ”¬ SPH å¯†åº¦è¨ˆç®—

- **Poly6 ã‚«ãƒ¼ãƒãƒ«**: å¯†åº¦è£œé–“ç”¨ã®å¹³æ»‘åŒ–ã‚«ãƒ¼ãƒãƒ«
- **è¿‘å‚æ¢ç´¢**: å…¨å¯¾å…¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç›¸äº’ä½œç”¨è¨ˆç®—
- **GPU ä¸¦åˆ—åŒ–**: 5,000 ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’åŒæ™‚è¨ˆç®—
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°**: æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å¯†åº¦ã‚’è¨ˆç®—

### ğŸ“Š SPH ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

- **å¹³æ»‘åŒ–é•·ï¼ˆhï¼‰**: è¿‘å‚å½±éŸ¿ç”¨ã‚«ãƒ¼ãƒãƒ«åŠå¾„
- **Poly6 ã‚«ãƒ¼ãƒãƒ«ä¿‚æ•°**: æ­£è¦åŒ–é‡ã¿é–¢æ•°
- **è³ªé‡**: å¯†åº¦å¯„ä¸ç”¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«è³ªé‡
- **ã‚«ãƒ¼ãƒãƒ«ã¹ãä¹—**: åŠ¹ç‡æ€§ã®ãŸã‚ã®äº‹å‰è¨ˆç®— hÂ²ã€hÂ³ã€hâ¶ã€hâ¹

### âš¡ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆã‚·ã‚§ãƒ¼ãƒ€ãƒ¼å®Ÿè£…

- **ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ‘ã‚¹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**: å¯†åº¦è¨ˆç®— â†’ ç‰©ç†ç©åˆ†
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒƒãƒ•ã‚¡**: ä½ç½®ã€é€Ÿåº¦ã€å¯†åº¦ãƒ‡ãƒ¼ã‚¿
- **ãƒ«ãƒ¼ãƒ—ãƒ™ãƒ¼ã‚¹è¿‘å‚æ¢ç´¢**: åŠ¹ç‡çš„ãª GPU è¨ˆç®—
- **éåŒæœŸåŒæœŸ**: é©åˆ‡ãª GPU ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆå®Œäº†

## æŠ€è¡“å®Ÿè£…

### SPH å¯†åº¦å…¬å¼

```typescript
// Poly6ã‚«ãƒ¼ãƒãƒ«ã‚’ä½¿ç”¨ã—ãŸSPHå¯†åº¦è¨ˆç®—
Ïáµ¢ = Î£â±¼ mâ±¼ W(|ráµ¢ - râ±¼|, h)
```

### TSL ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆã‚·ã‚§ãƒ¼ãƒ€ãƒ¼

```typescript
// å„ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®å¯†åº¦è¨ˆç®—
const rho0 = float(0.0).toVar();
Loop(j.lessThan(particleCount), () => {
  If(j.notEqual(instanceIndex), () => {
    const r = pos_j.sub(pos_i);
    const r2 = r.dot(r);
    If(r2.lessThan(h2), () => {
      const w = float(poly6Kernel).mul(pow(t, 3));
      rho0.addAssign(w.mul(mass));
    });
  });
});
```

### Poly6 ã‚«ãƒ¼ãƒãƒ«é–¢æ•°

```typescript
// SPH Poly6å¹³æ»‘åŒ–ã‚«ãƒ¼ãƒãƒ«
W(r, h) = (315 / (64Ï€hâ¹)) Ã— (hÂ² - rÂ²)Â³  ã‚‚ã— r < h
W(r, h) = 0                             ã‚‚ã— r â‰¥ h
```

## SPH è¨­å®š

### SPHConfig ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

- **mass**: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«è³ªé‡ï¼ˆ0.4ï¼‰
- **h**: å¹³æ»‘åŒ–é•·ï¼ˆ1.0ï¼‰
- **delta**: ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆ1/60 ç§’ï¼‰
- **restitution**: è¡çªå¼¾æ€§ï¼ˆ0.8ï¼‰

### ã‚«ãƒ¼ãƒãƒ«è¨ˆç®—

- **hÂ², hÂ³, hâ¶, hâ¹**: äº‹å‰è¨ˆç®—ã•ã‚ŒãŸã‚«ãƒ¼ãƒãƒ«ã¹ãä¹—
- **poly6Kernel**: æ­£è¦åŒ– Poly6 ä¿‚æ•°ï¼ˆ315/(64Ï€hâ¹)ï¼‰

## ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ‘ã‚¹ã‚·ã‚¹ãƒ†ãƒ 

```typescript
public async compute() {
  await this.computeDensity();    // ãƒ‘ã‚¹1: å¯†åº¦è¨ˆç®—
  await this.computeIntegrate();  // ãƒ‘ã‚¹2: ç‰©ç†ç©åˆ†
}
```

### ãƒãƒƒãƒ•ã‚¡ç®¡ç†

- **positionsBuffer**: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ä½ç½®ï¼ˆvec3 é…åˆ—ï¼‰
- **velocitiesBuffer**: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«é€Ÿåº¦ï¼ˆvec3 é…åˆ—ï¼‰
- **densitiesBuffer**: è¨ˆç®—ã•ã‚ŒãŸå¯†åº¦ï¼ˆfloat é…åˆ—ï¼‰

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹å¾´

### GPU æœ€é©åŒ–

- **ä¸¦åˆ—å¯†åº¦è¨ˆç®—**: å…¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’åŒæ™‚è¨ˆç®—
- **åŠ¹ç‡çš„è¿‘å‚æ¢ç´¢**: ãƒ«ãƒ¼ãƒ—ãƒ™ãƒ¼ã‚¹å…¨å¯¾å…¨è¨ˆç®—
- **ãƒ¡ãƒ¢ãƒªã‚³ã‚¢ãƒ¬ãƒƒã‚·ãƒ³ã‚°**: æœ€é©åŒ–ã•ã‚ŒãŸãƒãƒƒãƒ•ã‚¡ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³
- **éåŒæœŸã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆ**: éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚° GPU æ“ä½œ

### SPH åŠ¹ç‡æ€§

- **ã‚«ãƒ¼ãƒãƒ«äº‹å‰è¨ˆç®—**: æ•°å­¦å®šæ•°ã‚’ä¸€åº¦ã ã‘è¨ˆç®—
- **æ¡ä»¶åˆ†å²**: è¿‘å‚ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®ã¿è¨ˆç®—
- **ãƒ™ã‚¯ãƒˆãƒ«åŒ–æ“ä½œ**: GPU æœ€é©åŒ–ã•ã‚ŒãŸæ•°å­¦æ“ä½œ

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã“ã®å¯†åº¦è¨ˆç®—åŸºç›¤ã«ã‚ˆã‚Šä»¥ä¸‹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼š

- **åœ§åŠ›è¨ˆç®—**: è¨ˆç®—ã•ã‚ŒãŸå¯†åº¦ã‚’ä½¿ç”¨ã—ãŸåœ§åŠ›å‹¾é…
- **ç²˜æ€§åŠ›**: é€Ÿåº¦ãƒ™ãƒ¼ã‚¹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç›¸äº’ä½œç”¨
- **è¡¨é¢å¼µåŠ›**: ç•Œé¢æ¤œå‡ºã¨è¡¨é¢åŠ›
- **é«˜åº¦ãªã‚«ãƒ¼ãƒãƒ«**: Spikyã€Viscosityã€ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ¼ãƒãƒ«é–¢æ•°
- **ç©ºé–“æœ€é©åŒ–**: O(n)è¿‘å‚æ¢ç´¢ç”¨ã®ç©ºé–“ãƒãƒƒã‚·ãƒ¥
