# 10-particle-color - 速度ベースパーティクルカラーリング

> [English version is here](README.md)

TSL シェーダーを使用して流体速度を可視化する動的パーティクルカラーリングシステムで、パーティクルの速度に基づいて深い青から白い泡までリアルな水のような色変化を作成します。

## プロジェクト構造

```
src/
├── main.ts
└── app/
    ├── App.ts                    # 速度カラーリング対応メインアプリケーション
    ├── core/                     # コアマネージャー（前のプロジェクトから）
    ├── simulation/
    │   ├── boundary/
    │   │   ├── BoundaryBox.ts    # 境界コンテナ
    │   │   └── BoundaryConfig.ts # 境界設定
    │   └── sph/
    │       ├── Particle.ts       # 速度カラーリング付きSPHシステム
    │       ├── SPHConfig.ts      # maxSpeed付きSPHパラメータ
    │       └── calculate/        # コンピュートシェーダー（前のプロジェクトから）
    ├── utils/
    │   └── ParamsControls.ts     # GUI制御システム
    └── types/
        ├── UniformType.ts        # TSLユニフォーム型
        └── BufferType.ts         # ストレージバッファ型
```

## 主な特徴

### 🎨 動的速度カラーリング

- **速度ベースカラー**: パーティクルの色が速度の大きさに基づいて変化
- **リアルな水の色**: 深い青 → 中間青 → 白い泡への遷移
- **滑らかな補間**: 自然な遷移のための TSL ベースカラーミックス
- **リアルタイム更新**: 速度変化に伴う毎フレームの色更新

### 🌊 視覚的流体表現

- **深い水**: 深い青の低速パーティクル（0.0, 0.05, 0.9）
- **中間水**: 中間青の中速パーティクル（0.0, 0.6, 0.8）
- **白い泡**: 白い高速パーティクル（1.0, 1.0, 1.0）
- **自然な進行**: リアルな水の色物理シミュレーション

### ⚡ TSL シェーダー実装

- **速度計算**: シェーダー内でのリアルタイム速度計算
- **カラー補間**: TSL mix 関数を使用した滑らかな色遷移
- **パフォーマンス最適化**: 全パーティクル用の GPU ベースカラー計算
- **動的ライティング**: 環境光と拡散光の組み合わせ

## 技術実装

### 速度ベースカラー関数

```typescript
private getColorByVelocity = Fn(([speed]) => {
  const t = clamp(
    speed.div(float(this.sphConfig.maxSpeed)),
    float(0.0),
    float(1.0)
  ).toVar();

  const deep = vec3(0.0, 0.05, 0.9);    // 深い水の青
  const mid = vec3(0.0, 0.6, 0.8);      // 中間水の青
  const foam = vec3(1.0, 1.0, 1.0);     // 白い泡

  // 2段階カラー補間
  If(t.lessThan(float(0.85)), () => {
    const k = t.div(float(0.85));
    color.assign(mix(deep, mid, k));
  }).Else(() => {
    const k = t.sub(float(0.85)).div(float(0.15));
    color.assign(mix(mid, foam, k));
  });
});
```

### シェーダー内速度計算

```typescript
private updateMaterialColorNode() {
  this.sphereMaterial.colorNode = Fn(() => {
    // パーティクル速度を計算
    const speed = this.velocitiesBuffer
      .element(instanceIndex)
      .length();

    // 速度ベースカラーリングを適用
    const baseColor = this.getColorByVelocity(speed).toVar();

    // ライティングと組み合わせ
    return baseColor.mul(ambient).add(baseColor.mul(diffuse));
  })();
}
```

### SPH 設定

```typescript
export class SPHConfig {
  // ... 既存のパラメータ
  public maxSpeed = 10.0; // 色正規化用の最大速度
}
```

## カラーマッピングシステム

### 速度-カラーマッピング

- **0% - 85%速度**: 深い青 → 中間青への遷移
- **85% - 100%速度**: 中間青 → 白い泡への遷移
- **クランプ範囲**: 速度値を 0-1 範囲に正規化
- **滑らかな補間**: 自然なカラーブレンディング用 TSL mix 関数

### 視覚効果

- **低速パーティクル**: 深い、静かな水の外観
- **中速パーティクル**: 活発な水の動き
- **高速パーティクル**: 乱流泡と飛沫効果
- **動的ライティング**: すべての色に適用される環境光と拡散光

## パフォーマンス特徴

### GPU 最適化

- **シェーダーベース計算**: 全カラー計算を GPU で実行
- **リアルタイム更新**: 毎フレームカラー計算
- **効率的補間**: 滑らかな遷移用 TSL mix 関数
- **メモリ効率**: 追加のカラーバッファ不要

### 視覚品質

- **滑らかな遷移**: 速度範囲間の自然なカラーブレンディング
- **リアルな物理**: カラーが実際の流体動作を表現
- **動的応答**: 速度変化による即座の色変化
- **ライティング統合**: 適切な環境光と拡散光効果

## 統合の利点

### 科学的可視化

- **流れ分析**: 高速度と低速度領域の視覚的識別
- **乱流検出**: 白い泡が乱流領域を示す
- **流体力学**: 流体動作のリアルタイム可視化
- **教育価値**: 流体物理の明確な視覚表現

### 美的向上

- **リアルな外観**: 自然な水のような色進行
- **視覚的魅力**: 動的でカラフルなパーティクルシステム
- **没入感**: 流体シミュレーションの向上した視覚体験
- **プロ品質**: 本番対応の視覚効果

## 使用方法

### 視覚分析

1. **低速領域**: 深い青が静かでゆっくり動く流体を示す
2. **活発領域**: 中間青が通常の流体運動を示す
3. **乱流領域**: 白い泡が高速度の乱流領域をハイライト
4. **境界効果**: 境界近くの色変化が衝突力学を示す

### パラメータ調整

- **maxSpeed**: 色正規化用の最大速度しきい値を調整
- **カラー範囲**: 異なる色遷移用の速度しきい値を変更
- **ライティング**: 希望の外観用の環境光と拡散光を調整
